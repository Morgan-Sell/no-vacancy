{% extends "base.html" %}

{% block title %}NoVacancy ‚Äî Cancellation Prediction{% endblock %}

{% block content %}
<section class="card">
    <div class="card-header">
        <h2 class="card-title">Reservation Details</h2>
        <p class="card-subtitle">Enter booking information to predict cancellation likelihood</p>
    </div>

    <form id="booking-form" novalidate>
        <div class="form-grid">
            <!-- Guest Information Section -->
            <div class="form-section">
                <h3 class="form-section-title">
                    <span>üåø</span> Guest Information
                </h3>

                <div class="form-group">
                    <label class="form-label" for="number_of_adults">Number of Adults</label>
                    <input
                        type="number"
                        id="number_of_adults"
                        name="number of adults"
                        class="form-input"
                        value="2"
                        min="1"
                        max="10"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="number_of_children">Number of Children</label>
                    <input
                        type="number"
                        id="number_of_children"
                        name="number of children"
                        class="form-input"
                        value="0"
                        min="0"
                        max="10"
                    >
                </div>

                <div class="form-group">
                    <label class="form-label">Returning Guest</label>
                    <div class="toggle-group">
                        <button type="button" class="toggle-btn active" data-field="repeated" data-value="0">No</button>
                        <button type="button" class="toggle-btn" data-field="repeated" data-value="1">Yes</button>
                    </div>
                    <input type="hidden" id="repeated" name="repeated" value="0">
                </div>

                <div class="form-group">
                    <label class="form-label" for="p_c">Previous Cancellations</label>
                    <input
                        type="number"
                        id="p_c"
                        name="P-C"
                        class="form-input"
                        value="0"
                        min="0"
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="p_not_c">Previous Completed Stays</label>
                    <input
                        type="number"
                        id="p_not_c"
                        name="P-not-C"
                        class="form-input"
                        value="0"
                        min="0"
                    >
                </div>
            </div>

            <!-- Stay Details Section -->
            <div class="form-section">
                <h3 class="form-section-title">
                    <span>üå¥</span> Stay Details
                </h3>

                <div class="form-group">
                    <label class="form-label" for="weekend_nights">Weekend Nights</label>
                    <input
                        type="number"
                        id="weekend_nights"
                        name="number of weekend nights"
                        class="form-input"
                        value="1"
                        min="0"
                        max="14"
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="week_nights">Weekday Nights</label>
                    <input
                        type="number"
                        id="week_nights"
                        name="number of week nights"
                        class="form-input"
                        value="2"
                        min="0"
                        max="30"
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="lead_time">Days Until Arrival</label>
                    <input
                        type="number"
                        id="lead_time"
                        name="lead time"
                        class="form-input"
                        value="30"
                        min="0"
                        max="365"
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="date_of_reservation">Reservation Date</label>
                    <input
                        type="date"
                        id="date_of_reservation"
                        name="date of reservation"
                        class="form-input"
                    >
                </div>
            </div>

            <!-- Room & Services Section -->
            <div class="form-section">
                <h3 class="form-section-title">
                    <span>üèùÔ∏è</span> Room & Services
                </h3>

                <div class="form-group">
                    <label class="form-label" for="room_type">Room Type</label>
                    <select id="room_type" name="room type" class="form-select">
                        <option value="Room_Type 1">Standard Room</option>
                        <option value="Room_Type 2" selected>Deluxe Room</option>
                        <option value="Room_Type 3">Suite</option>
                        <option value="Room_Type 4">Premium Suite</option>
                        <option value="Room_Type 5">Penthouse</option>
                        <option value="Room_Type 6">Villa</option>
                        <option value="Room_Type 7">Presidential</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="meal_type">Meal Plan</label>
                    <select id="meal_type" name="type of meal" class="form-select">
                        <option value="Meal Plan 1" selected>Meal Plan 1</option>
                        <option value="Meal Plan 2">Meal Plan 2</option>
                        <option value="Meal Plan 3">Meal Plan 3</option>
                        <option value="Not Selected">No Meal Plan</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Parking Required</label>
                    <div class="toggle-group">
                        <button type="button" class="toggle-btn active" data-field="car_parking_space" data-value="0">No</button>
                        <button type="button" class="toggle-btn" data-field="car_parking_space" data-value="1">Yes</button>
                    </div>
                    <input type="hidden" id="car_parking_space" name="car parking space" value="0">
                </div>

                <div class="form-group">
                    <label class="form-label" for="special_requests">Special Requests</label>
                    <input
                        type="number"
                        id="special_requests"
                        name="special requests"
                        class="form-input"
                        value="0"
                        min="0"
                        max="5"
                    >
                </div>
            </div>

            <!-- Booking Info Section -->
            <div class="form-section">
                <h3 class="form-section-title">
                    <span>üå∫</span> Booking Info
                </h3>

                <div class="form-group">
                    <label class="form-label" for="market_segment">Booking Channel</label>
                    <select id="market_segment" name="market segment type" class="form-select">
                        <option value="Online" selected>Online</option>
                        <option value="Offline">Offline</option>
                        <option value="Corporate">Corporate</option>
                        <option value="Complementary">Complementary</option>
                        <option value="Aviation">Aviation</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="average_price">Nightly Rate ($)</label>
                    <input
                        type="number"
                        id="average_price"
                        name="average price"
                        class="form-input"
                        value="100.00"
                        min="0"
                        step="0.01"
                    >
                </div>
            </div>
        </div>

        <div class="card-actions">
            <button type="button" class="btn btn-secondary" id="train-btn">
                üîÑ Train Model
            </button>
            <button type="submit" class="btn btn-primary" id="predict-btn">
                üîÆ Predict Cancellation
            </button>
        </div>
    </form>
</section>

<section class="card result-section" id="result-section" style="display: none;">
    <h2 class="card-title text-center">Cancellation Risk Assessment</h2>
    <p class="card-subtitle text-center">Based on historical patterns and guest profile</p>
    <div class="result-display" id="result-display">
        <!-- Prediction result will be injected here by JavaScript -->
    </div>
    <p class="result-meta text-center" id="result-meta"></p>
</section>

<section class="card training-section" id="training-section" style="display: none;">
    <h2 class="card-title text-center">Training Progress</h2>
    <p class="card-subtitle text-center">Model retraining pipeline status</p>
    <div class="training-progress" id="training-progress">
        <!-- Training progress will be injected here by JavaScript -->
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';

    // ---------------------------------------------------------------------------
    // State
    // ---------------------------------------------------------------------------
    let currentDagRunId = null;
    let pollInterval = null;
    const POLL_DELAY = 3000;

    // ---------------------------------------------------------------------------
    // DOM Elements
    // ---------------------------------------------------------------------------
    const form = document.getElementById('booking-form');
    const predictBtn = document.getElementById('predict-btn');
    const trainBtn = document.getElementById('train-btn');
    const resultSection = document.getElementById('result-section');
    const resultDisplay = document.getElementById('result-display');
    const resultMeta = document.getElementById('result-meta');
    const trainingSection = document.getElementById('training-section');
    const trainingProgress = document.getElementById('training-progress');

    // ---------------------------------------------------------------------------
    // Initialization
    // ---------------------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function() {
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date_of_reservation').value = today;

        // Toggle button functionality
        initToggleButtons();

        // Form validation feedback
        initValidation();

        // Event listeners
        form.addEventListener('submit', handlePrediction);
        trainBtn.addEventListener('click', handleTraining);
    });

    function initToggleButtons() {
        document.querySelectorAll('.toggle-group').forEach(function(group) {
            const buttons = group.querySelectorAll('.toggle-btn');
            buttons.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const field = this.dataset.field;
                    const value = this.dataset.value;
                    const hiddenInput = document.getElementById(field);

                    buttons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    if (hiddenInput) {
                        hiddenInput.value = value;
                    }
                });
            });
        });
    }

    function initValidation() {
        const inputs = form.querySelectorAll('.form-input, .form-select');
        inputs.forEach(function(input) {
            input.addEventListener('invalid', function() {
                this.classList.add('invalid');
            });
            input.addEventListener('input', function() {
                if (this.validity.valid) {
                    this.classList.remove('invalid');
                }
            });
        });
    }

    // ---------------------------------------------------------------------------
    // Prediction
    // ---------------------------------------------------------------------------
    async function handlePrediction(event) {
        event.preventDefault();

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        setButtonLoading(predictBtn, true);
        hideResult();

        try {
            const formData = collectFormData();
            const response = await fetch('/api/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: [formData] })
            });

            const result = await response.json();

            if (result.error) {
                showError(result.error);
            } else if (result.predictions && result.predictions.length > 0) {
                displayPrediction(result.predictions[0], result.version);
            } else {
                showError('No prediction returned');
            }
        } catch (error) {
            showError('Failed to connect to prediction service');
            console.error('Prediction error:', error);
        } finally {
            setButtonLoading(predictBtn, false);
        }
    }

    function collectFormData() {
        const formData = new FormData(form);
        const data = {};

        // Convert FormData to object with proper types
        for (const [key, value] of formData.entries()) {
            // Number fields
            if (['number of adults', 'number of children', 'number of weekend nights',
                 'number of week nights', 'lead time', 'car parking space', 'repeated',
                 'P-C', 'P-not-C', 'special requests'].includes(key)) {
                data[key] = parseInt(value, 10);
            }
            // Float field
            else if (key === 'average price') {
                data[key] = parseFloat(value);
            }
            // Date field - format as MM/DD/YYYY for the model
            else if (key === 'date of reservation') {
                const date = new Date(value);
                data[key] = `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
            }
            // String fields
            else {
                data[key] = value;
            }
        }

        return data;
    }

    function displayPrediction(probability, version) {
        const percentage = (probability * 100).toFixed(1);
        let riskLevel, riskClass;

        if (probability > 0.7) {
            riskLevel = 'HIGH';
            riskClass = 'risk-high';
        } else if (probability > 0.4) {
            riskLevel = 'MODERATE';
            riskClass = 'risk-moderate';
        } else {
            riskLevel = 'LOW';
            riskClass = 'risk-low';
        }

        resultDisplay.innerHTML = `
            <div class="result-card ${riskClass}">
                <span class="percentage">${percentage}%</span>
                <span class="risk-label">${riskLevel} RISK</span>
            </div>
        `;

        resultMeta.textContent = `Model version: ${version}`;
        resultSection.style.display = 'block';
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // ---------------------------------------------------------------------------
    // Training
    // ---------------------------------------------------------------------------
    async function handleTraining() {
        if (currentDagRunId && pollInterval) {
            // Training already in progress
            return;
        }

        setButtonLoading(trainBtn, true);
        showTrainingSection();

        try {
            const response = await fetch('/api/train', { method: 'POST' });
            const result = await response.json();

            if (result.error) {
                showTrainingError(result.error);
                setButtonLoading(trainBtn, false);
            } else {
                currentDagRunId = result.dag_run_id;
                renderTrainingProgress([], 'queued');
                startPolling();
            }
        } catch (error) {
            showTrainingError('Failed to connect to training service');
            setButtonLoading(trainBtn, false);
            console.error('Training trigger error:', error);
        }
    }

    function startPolling() {
        pollInterval = setInterval(pollTrainingStatus, POLL_DELAY);
        // Also poll immediately
        pollTrainingStatus();
    }

    function stopPolling() {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
        currentDagRunId = null;
        setButtonLoading(trainBtn, false);
    }

    async function pollTrainingStatus() {
        if (!currentDagRunId) return;

        try {
            const [statusRes, tasksRes] = await Promise.all([
                fetch(`/api/train/status/${encodeURIComponent(currentDagRunId)}`),
                fetch(`/api/train/tasks/${encodeURIComponent(currentDagRunId)}`)
            ]);

            const status = await statusRes.json();
            const tasks = await tasksRes.json();

            if (status.error || tasks.error) {
                showTrainingError(status.error || tasks.error);
                stopPolling();
                return;
            }

            renderTrainingProgress(tasks.tasks || [], status.state, status.start_date);

            // Check terminal states
            if (status.state === 'success') {
                stopPolling();
                showTrainingSuccess();
            } else if (status.state === 'failed') {
                stopPolling();
                showTrainingFailed();
            }
        } catch (error) {
            console.error('Polling error:', error);
            // Don't stop polling on transient errors
        }
    }

    // ---------------------------------------------------------------------------
    // Training UI
    // ---------------------------------------------------------------------------
    const TASK_ORDER = [
        'import_csv_data',
        'train_and_register_model',
        'generate_predictions',
        'validate_model_artifacts',
        'notify_completion'
    ];

    const TASK_LABELS = {
        'import_csv_data': 'Import CSV Data',
        'train_and_register_model': 'Train & Register Model',
        'generate_predictions': 'Generate Test Predictions',
        'validate_model_artifacts': 'Validate Model',
        'notify_completion': 'Complete'
    };

    function renderTrainingProgress(tasks, dagState, startDate) {
        // Create lookup by task_id
        const taskMap = {};
        tasks.forEach(t => taskMap[t.task_id] = t);

        // Build HTML for each task in order
        let html = '';
        TASK_ORDER.forEach(taskId => {
            const task = taskMap[taskId];
            const state = task ? (task.state || 'pending') : 'pending';
            const icon = getTaskIcon(state);
            const label = TASK_LABELS[taskId] || taskId;

            html += `
                <div class="task-item">
                    <div class="task-icon ${state}">${icon}</div>
                    <span class="task-name ${state === 'pending' ? 'pending' : ''}">${label}</span>
                    <span class="task-status ${state}">${formatState(state)}</span>
                </div>
            `;
        });

        // Status bar
        const statusText = formatState(dagState);
        const timeText = startDate ? `Started: ${formatTime(startDate)}` : '';

        html += `
            <div class="training-status-bar">
                <span class="status-label">Status:</span>
                <span class="status-value">${statusText}</span>
                <span class="status-time">${timeText}</span>
            </div>
        `;

        trainingProgress.innerHTML = html;
    }

    function getTaskIcon(state) {
        switch (state) {
            case 'success': return '‚úì';
            case 'running': return '‚óê';
            case 'failed': return '‚úó';
            case 'upstream_failed': return '‚äò';
            default: return '‚óã';
        }
    }

    function formatState(state) {
        if (!state) return 'Pending';
        return state.charAt(0).toUpperCase() + state.slice(1).replace(/_/g, ' ');
    }

    function formatTime(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        return date.toLocaleTimeString();
    }

    function showTrainingSection() {
        trainingSection.style.display = 'block';
        trainingProgress.innerHTML = '<p class="text-center">Initiating training pipeline...</p>';
        trainingSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function showTrainingSuccess() {
        const statusBar = trainingProgress.querySelector('.training-status-bar');
        if (statusBar) {
            statusBar.innerHTML = `
                <span class="status-label">Status:</span>
                <span class="status-value" style="color: var(--green-dark);">‚úì Complete</span>
                <span class="status-time">Model registered successfully</span>
            `;
        }
    }

    function showTrainingFailed() {
        const statusBar = trainingProgress.querySelector('.training-status-bar');
        if (statusBar) {
            statusBar.innerHTML = `
                <span class="status-label">Status:</span>
                <span class="status-value" style="color: var(--terracotta);">‚úó Failed</span>
                <span class="status-time">Check Airflow logs for details</span>
            `;
        }
    }

    function showTrainingError(message) {
        trainingProgress.innerHTML = `
            <div class="training-error">
                <p style="color: var(--terracotta); text-align: center;">‚ö†Ô∏è ${message}</p>
            </div>
        `;
    }

    // ---------------------------------------------------------------------------
    // Utilities
    // ---------------------------------------------------------------------------
    function setButtonLoading(button, loading) {
        button.disabled = loading;
        if (loading) {
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = '‚è≥ Working...';
        } else if (button.dataset.originalText) {
            button.innerHTML = button.dataset.originalText;
        }
    }

    function hideResult() {
        resultSection.style.display = 'none';
    }

    function showError(message) {
        resultDisplay.innerHTML = `
            <div class="result-card" style="border-color: var(--terracotta); color: var(--terracotta);">
                <span style="font-size: 1.2rem;">‚ö†Ô∏è ${message}</span>
            </div>
        `;
        resultMeta.textContent = '';
        resultSection.style.display = 'block';
    }

})();
</script>
{% endblock %}
